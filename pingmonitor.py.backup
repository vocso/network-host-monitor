import subprocess
import platform
import time
import json
import smtplib
from email.message import EmailMessage
from datetime import datetime



# Load host list
with open("hosts.json") as f:
    data = json.load(f)
    hosts = data.get("hosts", [])

# Load email config
with open("config.json") as f:
    full_config = json.load(f)
    config = full_config["email"]
    config_config = full_config["config"]

# CONFIG
INTERVAL = config_config["interval"]  # seconds
MAX_FAILURES = config_config["max_failures"]
LOG_FILE = "downtime.log"

failures = {host["ip"]: 0 for host in hosts}
os_type = platform.system().lower()

def is_host_up(ip):
    param = "-n" if os_type == "windows" else "-c"
    try:
        output = subprocess.check_output(["ping", param, "1", ip], stderr=subprocess.STDOUT)
        return "100% packet loss" not in output.decode().lower()
    except subprocess.CalledProcessError:
        return False

def log_downtime(label, ip):
    now = datetime.now()
    log_entry = f"[{now.strftime('%Y-%m-%d %H:%M:%S')}] {label} ({ip}) is DOWN (timestamp: {now.timestamp()})\n"
    with open(LOG_FILE, "a") as log:
        log.write(log_entry)
    print("📝 Logged downtime:", log_entry.strip())

def send_email(label, ip):
    msg = EmailMessage()
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    msg['Subject'] = f"🚨🚨🚨Ping Alert: {label} is DOWN!"
    msg['From'] = config["sender"]
    msg['To'] = config["recipient"]
    msg.set_content(f"{label} ({ip}) was unreachable at {now}.\nPlease investigate immediately.")

    try:
        with smtplib.SMTP(config["smtp_server"], config["smtp_port"]) as server:
            server.starttls()
            server.login(config["sender"], config["password"])
            server.send_message(msg)
        print("📧 Email sent to", config["recipient"])
    except Exception as e:
        print("❌ Failed to send email:", e)

def send_alert(label, ip):
    message = f"{label} ({ip}) is DOWN!"
    print(f"🔔 ALERT: {message}")

    # Native notification
    if os_type == "darwin":
        subprocess.run(['osascript', '-e', f'display notification "{message}" with title "Ping Alert"'])
    elif os_type == "linux":
        subprocess.run(['notify-send', "Ping Alert", message])
    elif os_type == "windows":
        print("🟡 Windows notification not implemented.")

    log_downtime(label, ip)
    send_email(label, ip)

def print_status(label, ip, is_up, fail_count):
    status_icon = "✅" if is_up else "🚨🚨🚨"
    print(f"{status_icon} {label} ({ip}) - {'UP' if is_up else f'DOWN (Failure #{fail_count})'}")

# Main loop
while True:
    print(f"\n🕒 [{time.ctime()}] Starting Ping Checks...\n" + "-" * 50)
    for host in hosts:
        ip = host["ip"]
        label = host.get("label", ip)

        if is_host_up(ip):
            failures[ip] = 0
            print_status(label, ip, True, 0)
        else:
            failures[ip] += 1
            print_status(label, ip, False, failures[ip])
            if failures[ip] == MAX_FAILURES:  # alert once per downtime
                send_alert(label, ip)

    print("-" * 50)
    time.sleep(INTERVAL)
